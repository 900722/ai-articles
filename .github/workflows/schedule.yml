name: K√∂r AI-artiklar script dagligen

on:
  schedule:
    - cron: '0 7 * * *'  # K√∂rs varje dag kl 07:00 UTC
  workflow_dispatch:  # G√∂r det m√∂jligt att starta manuellt

jobs:
  run_scraper:
    runs-on: ubuntu-latest
    steps:
      - name: Klona repo
        uses: actions/checkout@v4

      - name: Installera Python och beroenden
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'  # S√§kerst√§ll att Python √§r installerat

      - name: Installera pip-paket
        run: pip install requests beautifulsoup4

      - name: Lista alla filer (fels√∂kning)
        run: ls -la

      - name: K√∂r Python-scriptet
        run: python3 scrape_github.py

      - name: Konfigurera SSH f√∂r autentisering
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.GH_SSH }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-add -l  # Kontrollera att nyckeln har laddats
          unset GH_SSH  # Rensar milj√∂variabeln efter anv√§ndning f√∂r √∂kad s√§kerhet

      - name: Testa SSH-anslutning
        run: ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -T git@github.com || true

      - name: St√§ll in Git och autentisering
        run: |
          git config --global user.email "lisa@maniola.se"
          git config --global user.name "900722"
          git remote remove origin || true  # Tar bort origin om det redan finns
          git remote add origin git@github.com:900722/ai-articles.git
          git fetch --all
          git remote -v

      - name: Kontrollera om det finns √§ndringar
        run: git status --short

      - name: Commit och pusha uppdaterade filer
        run: |
          if [ -f articles.json ] && [ -f previous_articles.json ]; then
            git add articles.json previous_articles.json
          else
            echo "‚ùó Fil saknas, hoppar √∂ver commit."
            exit 0
          fi

          # Kontrollera om det finns n√•gra √§ndringar att commit:a
          if git diff --cached --quiet; then
            echo "‚úÖ Inga √§ndringar att commit:a. Skippar push."
          else
            git commit -m "üîÑ Automatiskt uppdaterade artiklar"
            git log -1 --oneline
            GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" git push origin main
          fi
